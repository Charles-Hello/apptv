# 三端集成使用说明

## 架构说明

```
手机浏览器 ←扫码→ 油猴插件二维码 ←HTTP→ macOS Server (Flask)
    ↓                                        ↓
打开遥控器界面                           控制浏览器视频
http://192.168.1.16:5003
```

## 核心功能

### 1. Server 端 (main.py)
- **获取本机 IP**：优先获取 `192.168.x.x` 网段的局域网 IP
- **API 接口**：
  - `GET /get-local-ip` - 返回本机局域网IP和遥控器URL
  - `GET /` - 遥控器前端界面
  - `WebSocket` - 与油猴插件通信

### 2. 油猴插件 (all.js)
- **简化 UI**：只显示连接状态和二维码
- **自动获取 IP**：从 server 的 `/get-local-ip` 接口获取IP
- **生成二维码**：自动生成遥控器访问二维码
- **视频控制**：接收 server 的播放/暂停/URL跳转命令

### 3. 前端界面 (index.html)
- 手机访问 `http://192.168.1.16:5003`
- 通过 WebSocket 控制浏览器视频播放

## 使用流程

### 启动 Server
```bash
cd /Users/ken/Desktop/apptv
python3 main.py
```

启动后会显示：
```
============================================================
本机局域网IP: 192.168.1.16
遥控器访问地址: http://192.168.1.16:5003
============================================================
```

### 浏览器安装油猴插件
1. 在 macOS 浏览器访问目标网站（movie.tnanko.top、gdtv.cn、tv.cctv.com）
2. 油猴插件自动在右下角显示面板
3. 面板显示：
   - 连接状态：已连接/未连接
   - 二维码：指向 `http://192.168.1.16:5003`

### 手机扫码控制
1. 用手机扫描浏览器右下角的二维码
2. 自动跳转到 `http://192.168.1.16:5003`
3. 使用手机遥控器控制 macOS 浏览器视频

## 技术实现

### IP 获取优先级
1. `ipconfig getifaddr en0`（WiFi/以太网主接口）
2. `ipconfig getifaddr en1`（备用网卡）
3. 解析 `ifconfig` 输出，优先选择 `192.168.*`
4. Socket 连接外部地址（备用方案）

### 油猴插件获取 IP
```javascript
// 优先从 server 获取
const response = await fetch('http://localhost:5003/get-local-ip');
const data = await response.json();
const ip = data.ip; // 192.168.1.16

// 生成二维码
new QRCode(container, {
  text: `http://${ip}:5003`,
  width: 180,
  height: 180
});
```

## 测试验证

### 测试 IP 获取
```bash
python3 test_ip.py
```

预期输出：
```
✓ 获取到本机IP（en0）: 192.168.1.16
✓ 成功！IP匹配期望值: 192.168.1.16
```

### 测试 Server API
```bash
curl http://localhost:5003/get-local-ip
```

预期输出：
```json
{
  "success": true,
  "ip": "192.168.1.16",
  "url": "http://192.168.1.16:5003"
}
```

## 优势

1. **自动化**：无需手动配置 IP，server 自动获取并分发
2. **通用性**：任何连接到同一局域网的设备都可以扫码使用
3. **简化 UI**：油猴插件只显示必要信息，不干扰视频观看
4. **可靠性**：多种 IP 获取方案，保证稳定性

## 注意事项

- macOS 和手机必须在同一局域网（WiFi）
- Server 必须先启动，油猴插件才能获取到 IP
- 如果 IP 变化（如重新连接 WiFi），需要重启 server
